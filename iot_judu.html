<html lang="en">
<title>Mahtisovellus</title>
<meta charset="utf-8">
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.css">

<style>
    * {
        box-sizing: border-box;
    }

    .red {
        background: #f00;
        text-align: center;
        text-transform: uppercase;

    }

    .green {
        background: #0f0;
        text-align: center;
        text-transform: uppercase;

    }

    .linkbox {
        border: 1px solid black;
        display: inline-block;
        padding: 1em;
    }

    .box {
        border: 1px solid black;
        color: white;
        padding-top: 10px;
        padding-right: 20px;
        padding-bottom: 10px;
        padding-left: 20px;
    }

    .w {
        color: white;
    }

    body {
        font-family: Arial, Helvetica, sans-serif;
    }

    /* Style the header */
    header {
        background-color: #666;
        padding: 30px;
        text-align: center;
        font-size: 35px;
        color: white;
    }

    /* Create two columns/boxes that floats next to each other */
    nav {
        float: left;
        width: 30%;
        background: #ccc;
        padding: 20px;
        height: 100%;
    }

    /* Style the list inside the menu */
    nav ul {
        list-style-type: none;
        padding: 0;
    }

    article {
        float: left;
        padding: 20px;
        width: 70%;
        background-color: #f1f1f1;
        height: 100%;
    }

    /* Clear floats after the columns */
    section:after {
        content: "";
        display: table;
        clear: both;
    }

    /* Style the footer */
    footer {
        background-color: #777;
        padding: 10px;
        text-align: center;
        color: white;
    }

    /* Responsive layout - makes the two columns/boxes stack on top of each other instead of next to each other, on small screens */
    @media (max-width: 600px) {

        nav,
        article {
            width: 100%;
            height: auto;
        }
    }
</style>
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.js"></script>
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

<body>
    <header>
        <h2>Mahtisovellus</h2>
        <table>
            <tr>
                <th class="w">Temp</th>
                <th class="w">Humi</th>
                <th class="w">Timer</th>
                <th class="w">State</th>
            </tr>
            <tr>
                <td id="temp" class="box">22 &#8451</td>
                <td id="humi" class="box">12 %</td>
                <td id="timer" class="box">40</td>
                <td id="state" class="box">1</td>
            </tr>
        </table>
    </header>

    <section>
        <nav id="ruutu2">
            <form>
                <label for="ajastin">Ajastin (Mins)</label>
                <input type="number" id="ajastin" name="ajastin"><br><br>
            </form>
            <button type="button" onclick="Paalle(1)">Laita päälle</button>
            <button type="button" onclick="Paalle(0)">Laita pois päältä</button>
        </nav>



        <article id="ruutu">

            <div id="TempchartContainer" style="height: 300px; width: 50%;"></div>
            <div id="HumchartContainer" style="height: 300px; width: 50%;"></div>

        </article>
    </section>

    <footer>
        <p>Made by </p>
    </footer>
    <iframe name="huijausikkuna" style="display:none;"></iframe>
</body>

</html>

<script>
    const url = "http://88.148.208.176:2236";
    var TempValues = [];
    var tempchart;
    var HumValues = [];
    var Humchart;





    $(document).ready(function () {
        ($("#state").text() == 1) ? $('#state').addClass("green").text("on") : ('#state').addClass("red").text("off");
        $('#temp').text(77 + String.fromCharCode(176) + "C");
        $('#timer').text(secondsTimeSpanToHMS(2222));


        tempchart = new CanvasJS.Chart("TempchartContainer", {
            animationEnabled: true,
            theme: "light2",
            title: {
                text: "Lämpötila"
            },
            axisY: {
                includeZero: false
            },
            data: [{
                type: "line",
                dataPoints: TempValues
            }]
        });
        tempchart.render();



        Humchart = new CanvasJS.Chart("HumchartContainer", {
            animationEnabled: true,
            theme: "light2",
            title: {
                text: "Kosteus"
            },
            axisY: {
                includeZero: false
            },
            data: [{
                type: "line",
                dataPoints: HumValues
            }]
        });
        Humchart.render();

        var jqxhr = $.get(url + "/data", function (data, status) {
            if (data.State == 1) {
                var mennytAika = data.Time;

                paivitysfunktio();

                if (mennytAika > 0)
                    updateGraphs(mennytAika);

            }
        });


        setInterval(function () {
            //ajastin joka päivittää graafit ja ikkunat
            paivitysfunktio();
            updateGraphs(0);
        }, 1000);
    });

    function updateGraphs(aika) {
        //päivittää graafit (pitäisikö varmaan ottaa parametreinä ajanjakso?)
        //jos aika 0 hakee viimeisimmän rivin
        var maxDate = Date.parse($("#datepickerMax").val()) || new Date();
        var minDate = Date.parse($("#datepickerMin").val()) || 0;

        var newurl = url + "/data?start_time=" + minDate + "&end_time=" + maxDate;

        if (aika == 0)
            var newurl = url + "/data";

        var jqxhr = $.get(newurl, function (data, status) {
            //get metodi joka hakee Temp,Hum,Ajanhetki, State
            data.forEach(tempObjekti => {
                let tempV = new {
                    y: tempObjekti.Temp,
                    x: tempObjekti.SavedAt
                }
                let HumV = new {
                    y: tempObjekti.Hum,
                    x: tempObjekti.SavedAt
                }
                HumValues.push(HumV);
                TempValues.push(tempV);

            });

            Humchart.render();
            tempchart.render();
        });
    }


    function paivitysfunktio() {//päivittää ylälaidassa olevat valuet
        var jqxhr = $.get(url + "/data", function (data, status) {
            $('#temp').text(data.Temp + String.fromCharCode(176) + "C"),
                $('#humi').text(data.Hum + " %"),
                // $('#timer').text(secondsTimeSpanToHMS(data.Time)),
                (data.State == 1) ? $('#state').addClass("green").text("on") : ('#state').addClass("red").text("off");
        });
    }
    function secondsTimeSpanToHMS(s) {//tärkeä sekunnit h:m:s muotoon funktio
        var h = Math.floor(s / 3600);
        s -= h * 3600;
        var m = Math.floor(s / 60);
        s -= m * 60;
        return h + ":" + (m < 10 ? '0' + m : m) + ":" + (s < 10 ? '0' + s : s);
    }


    function Paalle(state) {

        if (state == 1) {//hieno tietoturva ominaisuus
            var pw = prompt("Syötä salasana", "");

            if (pw == undefined || pw != salainensana)//kovakoodattu salasana
                return

            var aika = $("#ajastin").val() * 60;
        }

        var newState = { "state": state }


        $.ajax({//annetaan negatiivinen aika ajastimelle
            url: url + "/switch",
            type: 'POST',
            data: newState,
            success: function (data) {
                console.log("Kiukaan state muutettu")
                $('#state').addClass("green").text("on");
            }
        });
    };

</script>